{{- if .Values.secrets.inline.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "ic-autopilot.fullname" . }}-secrets
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "ic-autopilot.labels" . | nindent 4 }}
type: Opaque
data:
  AZURE_OPENAI_API_KEY: {{ .Values.secrets.inline.azureOpenaiApiKey | b64enc | quote }}
  AZURE_SEARCH_API_KEY: {{ .Values.secrets.inline.azureSearchApiKey | b64enc | quote }}
  POSTGRES_PASSWORD: {{ .Values.secrets.inline.postgresPassword | b64enc | quote }}
{{- end }}
---
{{- if .Values.secrets.azureKeyVault.enabled }}
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: {{ include "ic-autopilot.fullname" . }}-kv
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "ic-autopilot.labels" . | nindent 4 }}
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "false"
    clientID: {{ .Values.azure.workloadIdentity.clientId | quote }}
    keyvaultName: {{ .Values.secrets.azureKeyVault.vaultName | quote }}
    tenantId: {{ .Values.secrets.azureKeyVault.tenantId | quote }}
    objects: |
      array:
        - |
          objectName: azure-openai-api-key
          objectType: secret
          objectAlias: AZURE_OPENAI_API_KEY
        - |
          objectName: azure-search-api-key
          objectType: secret
          objectAlias: AZURE_SEARCH_API_KEY
        - |
          objectName: postgres-password
          objectType: secret
          objectAlias: POSTGRES_PASSWORD
  secretObjects:
    - secretName: {{ include "ic-autopilot.fullname" . }}-kv-secrets
      type: Opaque
      data:
        - objectName: AZURE_OPENAI_API_KEY
          key: AZURE_OPENAI_API_KEY
        - objectName: AZURE_SEARCH_API_KEY
          key: AZURE_SEARCH_API_KEY
        - objectName: POSTGRES_PASSWORD
          key: POSTGRES_PASSWORD
{{- end }}
